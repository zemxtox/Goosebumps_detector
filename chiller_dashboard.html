<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#013D5A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="A mobile app to detect goosebumps from video or camera">
  <title>Goosebumps Detector</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icons/icon-192x192.png" type="image/png">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
  <style>
    :root {
        --midnight: #013D5A;
        --lionsmane: #FCF3E3;
        --celeste: #BDD3CE;
        --herb: #708C69;
        --marigold: #F4A258;
        --text-dark: #333333;
        --text-light: #FFFFFF;
        --success: #4CAF50;
        --danger: #F44336;
        --warning: #FF9800;
    }
    
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, var(--midnight) 0%, #025f7a 100%);
      color: var(--text-light); 
      min-height: 100vh; 
      overflow-x: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    @media (min-width: 768px) {
      .container {
        padding: 1.5rem;
      }
    }
    
    .header { 
      text-align: center; 
      padding: 1.5rem 1rem;
      margin-bottom: 1.5rem;
      background: rgba(255, 255, 255, 0.08); 
      backdrop-filter: blur(20px); 
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.12); 
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    
    .header h1 { 
      font-size: clamp(1.5rem, 5vw, 2.5rem);
      font-weight: 800; 
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--lionsmane) 0%, var(--celeste) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header p { 
      font-size: clamp(0.875rem, 2vw, 1rem);
      opacity: 0.9; 
      color: var(--celeste);
    }
    
    .install-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--marigold);
      color: var(--midnight);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      font-size: 0.875rem;
      cursor: pointer;
      display: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(244, 162, 88, 0.3);
    }
    
    .install-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(244, 162, 88, 0.4);
    }
    
    @media (max-width: 640px) {
      .install-button {
        position: static;
        margin-top: 1rem;
        display: inline-block;
      }
    }
    
    .offline-notification {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--warning);
      color: white;
      text-align: center;
      padding: 0.75rem;
      font-weight: 700;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .controls-section {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }
    
    .camera-controls { 
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 640px) {
      .camera-controls {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .btn { 
      padding: 0.875rem 1.5rem;
      border: none; 
      border-radius: 0.75rem;
      font-weight: 700;
      font-size: 0.9375rem;
      cursor: pointer; 
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); 
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, var(--celeste) 0%, #9fc9c3 100%);
      color: var(--midnight);
    }
    
    .btn-secondary { 
      background: rgba(255, 255, 255, 0.12); 
      color: white; 
      border: 1px solid rgba(255, 255, 255, 0.2); 
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--herb) 0%, #5d7556 100%);
      color: white;
    }
    
    .file-upload { display: none; }
    
    .video-container { 
      position: relative; 
      width: 100%; 
      max-width: 800px; 
      margin: 0 auto 1.5rem; 
      background: #000; 
      border-radius: 1rem;
      overflow: hidden; 
      display: none;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4); 
      border: 2px solid rgba(255, 255, 255, 0.15);
    }
    
    .video-container.active { 
      display: block; 
    }
    
    .video-container video { 
      width: 100%; 
      height: auto; 
      display: block; 
    }
    
    .camera-overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      justify-content: space-between; 
      pointer-events: none; 
    }
    
    .camera-controls-top { 
      display: flex; 
      justify-content: space-between; 
      padding: 1rem;
      gap: 0.5rem;
    }
    
    .camera-btn { 
      background: rgba(0,0,0,0.7); 
      color: white; 
      border: 2px solid rgba(255,255,255,0.3); 
      border-radius: 50%; 
      width: 48px; 
      height: 48px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 1.25rem;
      cursor: pointer; 
      pointer-events: auto; 
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }
    
    .camera-btn:hover { 
      background: rgba(0,0,0,0.9); 
      transform: scale(1.1);
      border-color: rgba(255,255,255,0.5);
    }
    
    .video-info {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .detection-badge {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, var(--success) 0%, #45a049 100%);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-weight: 700;
      animation: pulse 1.5s ease-in-out infinite;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.9; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    
    .live-graph-container { 
      width: 100%;
      max-width: 800px;
      margin: 0 auto 1.5rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      padding: 1.5rem;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .live-graph-container.active { 
      display: block; 
    }
    
    .graph-title {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--lionsmane);
    }
    
    .device-selector { 
      text-align: center; 
      margin-bottom: 1.5rem;
    }
    
    .device-selector select { 
      background: rgba(255, 255, 255, 0.12); 
      border: 2px solid rgba(255, 255, 255, 0.2); 
      color: white;
      padding: 0.875rem 1.25rem;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer; 
      min-width: min(300px, 100%);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .device-selector select:hover {
      border-color: var(--celeste);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .device-selector select option { 
      background: var(--midnight); 
      color: white;
    }
    
    .panel { 
      background: rgba(255, 255, 255, 0.08); 
      backdrop-filter: blur(20px); 
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.12); 
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); 
    }
    
    .panel-title { 
      font-size: clamp(1.25rem, 3vw, 1.5rem);
      font-weight: 700; 
      margin-bottom: 1.25rem;
      display: flex; 
      align-items: center; 
      gap: 0.75rem;
      color: var(--lionsmane);
    }
    
    .cards-grid { 
      display: grid; 
      gap: 1.25rem;
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 640px) {
      .cards-grid { 
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      }
    }
    
    .device-card { 
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 1rem;
      overflow: hidden;
      display: flex; 
      flex-direction: column;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .device-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }
    
    .device-card__header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 1rem 1.25rem;
      background: rgba(0, 0, 0, 0.4); 
      border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
    }
    
    .device-card__title-container { 
      display: flex; 
      align-items: center; 
      gap: 0.625rem;
    }
    
    .device-card__title { 
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.3px; 
    }
    
    .status-indicator { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      transition: all 0.3s ease;
      box-shadow: 0 0 8px currentColor;
    }
    
    .status-indicator.active { 
      background-color: var(--success);
    }
    
    .status-indicator.inactive { 
      background-color: var(--danger);
    }
    
    .device-card__actions { 
      display: flex; 
      gap: 0.5rem;
    }
    
    .sm-btn { 
      padding: 0.5rem 0.875rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.12);
      color: white;
      font-weight: 600;
      font-size: 0.8125rem;
      cursor: pointer; 
      transition: all 0.2s ease;
    }
    
    .sm-btn:hover { 
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    .device-card__feed { 
      position: relative; 
      background: #000; 
      height: 200px;
      overflow: hidden;
    }
    
    .device-card__feed img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block; 
    }
    
    .feed-overlay { 
      position: absolute; 
      top: 0.75rem;
      left: 0.75rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.8125rem;
      font-weight: 700; 
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .baseline { 
      background: linear-gradient(135deg, var(--marigold) 0%, #e89048 100%);
      color: white;
    }
    
    .monitor { 
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    
    .detect { 
      background: linear-gradient(135deg, var(--herb) 0%, #5d7556 100%);
      color: white;
    }
    
    .device-card__stats { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .stat { 
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      text-align: center; 
      padding: 0.75rem 0.5rem;
      transition: all 0.3s ease;
    }
    
    .stat:hover {
      background: rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }
    
    .stat .label { 
      font-size: 0.6875rem;
      opacity: 0.8; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      color: var(--celeste);
      margin-bottom: 0.25rem;
    }
    
    .stat .val { 
      font-size: 1.125rem;
      font-weight: 800;
      color: var(--lionsmane);
    }
    
    .device-card__chart { 
      height: 220px;
      padding: 1rem;
    }
    
    .action-controls {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 640px) {
      .action-controls {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .https-warning {
      background: rgba(244, 162, 88, 0.15);
      border: 2px solid var(--marigold);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1rem;
      text-align: center;
    }
    
    .https-warning p {
      margin: 0.25rem 0;
      color: var(--marigold);
      font-weight: 600;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    .custom-tooltip {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #ff0000;
      border-radius: 4px;
      padding: 8px;
      color: white;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="offlineNotification" class="offline-notification">
    ‚ö† You are currently offline. Some features may be limited.
  </div>
  
  <div class="container">
    <div class="header">
      <h1>‚ùÑ Goosebumps Detector</h1>
      <p>Real-time detection and analysis dashboard</p>
      <button id="installButton" class="install-button">üì± Install App</button>
      <div id="httpsWarning" class="https-warning" style="display: none;">
        <p>‚ö† For full functionality (PWA + Camera), use HTTPS or localhost</p>
        <p>Current: <span id="currentProtocol"></span></p>
      </div>
    </div>
    
    <div class="controls-section">
      <div class="camera-controls">
        <button class="btn btn-primary" id="cameraBtn">
          <span>üì∑</span> Detect from Camera
        </button>
        <label class="btn btn-success">
          <span>üì§</span> Upload Video
          <input type="file" class="file-upload" id="videoUpload" accept="video/*">
        </label>
      </div>
    </div>
    
    <div class="video-container" id="videoContainer">
      <video id="videoElement" autoplay playsinline muted></video>
      <div class="camera-overlay">
        <div class="camera-controls-top">
          <button class="camera-btn" id="closeVideoBtn" title="Close Camera">‚úï</button>
          <button class="camera-btn" id="flashlightBtn" title="Toggle Flashlight">üí°</button>
        </div>
      </div>
      <div id="videoInfoOverlay"></div>
    </div>
    
    <div class="live-graph-container" id="liveGraphContainer">
      <div class="graph-title">
        üìä Live Intensity Graph
        <button id="scaleToggle" class="sm-btn" style="margin-left: 1rem;">Auto Scale</button>
      </div>
      <div id="liveGraph"></div>
    </div>
    
    <div class="device-selector">
      <select id="deviceSelect">
        <option value="all">All Active Devices</option>
      </select>
    </div>
    
    <div class="panel">
      <div class="panel-title">
        <span>üìπ</span> Live Feeds & Statistics
      </div>
      <div id="cardsGrid" class="cards-grid"></div>
    </div>
    
    <div class="panel">
      <div class="panel-title">
        <span>‚öô</span> Controls
      </div>
      <div class="action-controls">
        <button class="btn btn-primary" id="resetBaseline">
          üîÑ Reset Baseline
        </button>
        <button class="btn btn-secondary" id="exportData">
          üíæ Export Data
        </button>
      </div>
    </div>
  </div>

  <script>
    (function checkProtocol() {
      const isSecure = window.isSecureContext;
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      const httpsWarning = document.getElementById('httpsWarning');
      const currentProtocol = document.getElementById('currentProtocol');
      if (currentProtocol) {
        currentProtocol.textContent = protocol + '//' + hostname;
      }
      const isRailway = hostname.includes('railway.app');
      const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
      if (!isSecure && !isLocalhost && !isRailway) {
        if (httpsWarning) httpsWarning.style.display = 'block';
      }
    })();
    
    let deferredPrompt = null;
    let isOnline = navigator.onLine;
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
          console.log('‚úÖ ServiceWorker registered:', registration.scope);
        } catch (error) {
          console.error('‚ùå ServiceWorker registration failed:', error);
        }
      });
      
      const installButton = document.getElementById('installButton');
      
      function checkIfInstalled() {
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
          if (installButton) installButton.style.display = 'none';
          return true;
        }
        return false;
      }
      
      if (installButton && !checkIfInstalled()) {
        installButton.style.display = 'block';
      }
      
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (installButton) installButton.style.display = 'block';
      });
      
      if (installButton) {
        installButton.addEventListener('click', async () => {
          if (!deferredPrompt) {
            const ua = navigator.userAgent;
            if (/iPhone|iPad|iPod/.test(ua)) {
              alert('To install on iOS:\n\n1. Tap Share (‚ñ°‚Üë)\n2. Tap "Add to Home Screen"\n3. Tap "Add"');
            } else if (/Android/.test(ua)) {
              alert('To install on Android:\n\n1. Tap menu (‚ãÆ)\n2. Tap "Add to Home screen"\n3. Follow prompts');
            } else {
              alert('Look for "Install" in your browser menu');
            }
            return;
          }
          try {
            await deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('Install prompt result: ' + outcome);
            deferredPrompt = null;
            installButton.style.display = 'none';
          } catch (error) {
            console.error('Install error:', error);
          }
        });
      }
      
      const offlineNotification = document.getElementById('offlineNotification');
      function updateOnlineStatus() {
        if (navigator.onLine) {
          if (offlineNotification) offlineNotification.style.display = 'none';
          document.body.classList.remove('offline');
        } else {
          if (offlineNotification) offlineNotification.style.display = 'block';
          document.body.classList.add('offline');
        }
      }
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();
    }
    
    const socket = io();
    let selectedDevice = 'all';
    const deviceCards = new Map();
    const deviceLastActive = new Map();
    const INACTIVE_THRESHOLD = 60000;
    
    const chartOptions = {
      chart: {
        type: 'line',
        height: 220,
        background: 'transparent',
        animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 400 } },
        toolbar: { show: false },
        zoom: { enabled: false }
      },
      stroke: { curve: 'straight', width: 3 },
      markers: { 
        size: 4,
        colors: ['#ff0000'],
        strokeColors: '#fff',
        strokeWidth: 1,
        hover: { size: 6 }
      },
      fill: { type: 'solid', opacity: 0 },
      dataLabels: { enabled: false },
      xaxis: {
        type: 'numeric',
        title: { text: 'Frame', style: { color: '#fff', fontWeight: 700 }},
        labels: { style: { colors: '#fff' } },
        axisBorder: { color: 'rgba(255,255,255,0.2)' },
        axisTicks: { color: 'rgba(255,255,255,0.2)' }
      },
      yaxis: {
        min: 0,
        max: 400,
        title: { text: 'Goosebump intensity', style: { color: '#fff', fontWeight: 700 }},
        labels: { style: { colors: '#fff' } }
      },
      grid: { borderColor: 'rgba(255,255,255,0.1)', strokeDashArray: 3 },
      tooltip: { 
        theme: 'dark',
        custom: function({series, seriesIndex, dataPointIndex, w}) {
          const value = series[seriesIndex][dataPointIndex];
          const frame = w.globals.categoryLabels[dataPointIndex] || w.globals.labels[dataPointIndex];
          return '<div class="custom-tooltip"><strong>Frame:</strong> ' + frame + '<br><strong>Intensity:</strong> ' + value.toFixed(1) + '%</div>';
        }
      },
      colors: ['#ff0000'],
      plotOptions: {
        line: {
          dropShadow: {
            enabled: true,
            color: '#ff0000',
            top: 0,
            left: 0,
            blur: 3,
            opacity: 0.5
          }
        }
      },
      theme: { mode: 'dark' }
    };

    const liveGraphOptions = { ...chartOptions, chart: { ...chartOptions.chart, id: 'live-graph', height: 300 } };
    const liveChart = new ApexCharts(document.getElementById('liveGraph'), {
      ...liveGraphOptions,
      series: [{ name: 'Goosebump intensity', data: [] }]
    });
    liveChart.render();

    function buildCard(id) {
      if (deviceCards.has(id)) return deviceCards.get(id);
      const grid = document.getElementById('cardsGrid');
      const card = document.createElement('div');
      card.className = 'device-card';
      card.dataset.device = id;
      const header = document.createElement('div');
      header.className = 'device-card__header';
      const titleContainer = document.createElement('div');
      titleContainer.className = 'device-card__title-container';
      const title = document.createElement('div');
      title.className = 'device-card__title';
      title.textContent = id;
      const statusIndicator = document.createElement('div');
      statusIndicator.className = 'status-indicator active';
      titleContainer.append(title, statusIndicator);
      const actions = document.createElement('div');
      actions.className = 'device-card__actions';
      const btnReset = document.createElement('button');
      btnReset.className = 'sm-btn';
      btnReset.textContent = 'Reset';
      btnReset.onclick = () => perDeviceReset(id);
      const btnCSV = document.createElement('button');
      btnCSV.className = 'sm-btn';
      btnCSV.textContent = 'Export';
      btnCSV.onclick = () => perDeviceExport(id);
      actions.append(btnReset, btnCSV);
      header.append(titleContainer, actions);
      const feed = document.createElement('div');
      feed.className = 'device-card__feed';
      const img = document.createElement('img');
      img.alt = 'Device feed';
      const overlay = document.createElement('div');
      overlay.className = 'feed-overlay monitor';
      overlay.textContent = 'Initializing...';
      feed.append(img, overlay);
      const stats = document.createElement('div');
      stats.className = 'device-card__stats';
      const s1 = statBox('Baseline');
      const s2 = statBox('Power');
      const s3 = statBox('Detects');
      const s4 = statBox('Frames');
      stats.append(s1.root, s2.root, s3.root, s4.root);
      const chartWrap = document.createElement('div');
      chartWrap.className = 'device-card__chart';
      chartWrap.id = 'chart-' + id;
      card.append(header, feed, stats, chartWrap);
      grid.appendChild(card);
      const chartEl = document.getElementById('chart-' + id);
      const chart = new ApexCharts(chartEl, {
        ...chartOptions,
        series: [{ name: 'Goosebump intensity', data: [] }]
      });
      chart.render();
      const entry = {
        root: card,
        img: img,
        overlay: overlay,
        stats: { baseline: s1, power: s2, detect: s3, frames: s4 },
        chart: chart,
        chartData: [],
        detections: []
      };
      deviceCards.set(id, entry);
      return entry;
    }
    
    function statBox(label) {
      const root = document.createElement('div');
      root.className = 'stat';
      const l = document.createElement('div');
      l.className = 'label';
      l.textContent = label;
      const v = document.createElement('div');
      v.className = 'val';
      v.textContent = '--';
      root.append(l, v);
      return { root: root, labelEl: l, valEl: v, set: (x) => v.textContent = x };
    }
    
    function applyFilter() {
      const grid = document.getElementById('cardsGrid');
      const select = document.getElementById('deviceSelect');
      const activeDeviceIds = new Set();
      for (let i = 1; i < select.options.length; i++) {
        const value = select.options[i].value;
        if (value !== 'all') activeDeviceIds.add(value);
      }
      if (selectedDevice === 'all') {
        deviceCards.forEach(({ root }, id) => {
          root.style.display = activeDeviceIds.has(id) ? 'flex' : 'none';
        });
      } else {
        deviceCards.forEach(({ root }, id) => {
          root.style.display = (id === selectedDevice) ? 'flex' : 'none';
        });
      }
    }
    
    async function perDeviceReset(id) {
      try {
        const r = await fetch('/reset_baseline/' + id, { method: 'POST' });
        if (r.ok) alert('‚úÖ Baseline reset for ' + id);
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
    
    function perDeviceExport(id) {
      const entry = deviceCards.get(id);
      if (!entry || entry.detections.length === 0) {
        alert('‚ùå No detections to export!');
        return;
      }
      const csv = 'Device,Time,Frame,Intensity\n' + entry.detections.map(d => id + ',' + d.time + ',' + d.frame + ',' + d.intensity).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'goosebumps_' + id + '_' + Date.now() + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    document.getElementById('resetBaseline').onclick = async () => {
      if (selectedDevice === 'all') {
        const ids = Array.from(deviceCards.keys());
        if (!ids.length) return;
        if (!confirm('Reset baseline for ALL devices?')) return;
        await Promise.all(ids.map(id => fetch('/reset_baseline/' + id, { method: 'POST' })));
        alert('‚úÖ Baselines reset for all devices');
      } else {
        perDeviceReset(selectedDevice);
      }
    };
    
    document.getElementById('exportData').onclick = () => {
      if (selectedDevice === 'all') {
        const rows = [];
        deviceCards.forEach((entry, id) => {
          entry.detections.forEach(d => rows.push(id + ',' + d.time + ',' + d.frame + ',' + d.intensity));
        });
        if (!rows.length) {
          alert('‚ùå No detections to export!');
          return;
        }
        const csv = 'Device,Time,Frame,Intensity\n' + rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'goosebumps_ALL_' + Date.now() + '.csv';
        a.click();
        URL.revokeObjectURL(url);
      } else {
        perDeviceExport(selectedDevice);
      }
    };
    
    socket.on('frame', (data) => {
      console.log('Received frame data:', data.device_id, 'Frame:', data.frame_number, 'Intensity:', data.goosebump_intensity, 'Baseline:', data.baseline_established);
      if (!(selectedDevice === 'all' || data.device_id === selectedDevice)) return;
      const entry = buildCard(data.device_id);
      deviceLastActive.set(data.device_id, Date.now());
      if (data.device_id.startsWith('mobile-camera-') && videoInfoOverlay) {
        const existingDetection = videoInfoOverlay.querySelector('.detection-badge');
        if (data.detect && !existingDetection) {
          const badge = document.createElement('div');
          badge.className = 'detection-badge';
          badge.textContent = 'üéØ Goosebumps! ' + data.goosebump_intensity.toFixed(1) + '%';
          videoInfoOverlay.appendChild(badge);
        } else if (!data.detect && existingDetection) {
          existingDetection.remove();
        } else if (data.detect && existingDetection) {
          existingDetection.textContent = 'üéØ Goosebumps! ' + data.goosebump_intensity.toFixed(1) + '%';
        }
      }
      entry.root.style.display = 'flex';
      const statusIndicator = entry.root.querySelector('.status-indicator');
      if (statusIndicator) {
        statusIndicator.classList.remove('inactive');
        statusIndicator.classList.add('active');
      }
      try {
        entry.img.src = 'data:image/jpeg;base64,' + data.img;
      } catch (e) {
        console.error('Error updating image:', e);
      }
      if (!data.baseline_established) {
        entry.overlay.className = 'feed-overlay baseline';
        entry.overlay.textContent = 'Recording baseline (Frame: ' + data.frame_number + ')';
      } else if (data.detect) {
        entry.overlay.className = 'feed-overlay detect';
        entry.overlay.textContent = 'üéØ Goosebumps! ' + data.goosebump_intensity.toFixed(1) + '%';
      } else {
        entry.overlay.className = 'feed-overlay monitor';
        entry.overlay.textContent = 'Monitoring (Frame: ' + data.frame_number + ')';
      }
      entry.stats.frames.set(data.frame_number);
      entry.stats.detect.set(data.detection_count);
      entry.stats.power.set(data.current_power.toFixed(2));
      entry.stats.baseline.set(data.baseline_established ? data.baseline_power.toFixed(2) : '...');
      if (data.baseline_established) {
        entry.chartData.push({ x: data.frame_number, y: data.goosebump_intensity });
        if (entry.chartData.length > 250) {
          entry.chartData = entry.chartData.slice(-250);
        }
        entry.chart.updateSeries([{
          name: 'Goosebump intensity',
          data: entry.chartData
        }], true);
        const liveGraphContainer = document.getElementById('liveGraphContainer');
        if (liveGraphContainer && !liveGraphContainer.classList.contains('active')) {
          liveGraphContainer.classList.add('active');
        }
        updateLiveGraph(data.goosebump_intensity, data.frame_number);
      }
      if (data.detect) {
        entry.detections.push({
          time: data.timestamp,
          intensity: data.goosebump_intensity,
          frame: data.frame_number
        });
      }
      applyFilter();
    });
    
    socket.on('devices', (msg) => updateDeviceList(msg.devices || []));
    
    function updateDeviceList(devices) {
      const select = document.getElementById('deviceSelect');
      const current = select.value || 'all';
      select.innerHTML = '<option value="all">All Active Devices</option>';
      const activeDeviceIds = new Set();
      devices.forEach(dev => {
        const info = typeof dev === 'object' ? dev : { id: dev };
        const opt = document.createElement('option');
        opt.value = info.id;
        opt.textContent = info.id + ' ' + (info.baseline_ready ? '‚úì' : '‚è≥');
        select.appendChild(opt);
        buildCard(info.id);
        activeDeviceIds.add(info.id);
      });
      deviceCards.forEach((entry, id) => {
        if (!activeDeviceIds.has(id)) {
          entry.root.style.display = 'none';
        }
      });
      if (current !== 'all' && !activeDeviceIds.has(current)) {
        select.value = 'all';
        selectedDevice = 'all';
      } else {
        select.value = current;
        selectedDevice = current;
      }
      applyFilter();
    }
    
    document.getElementById('deviceSelect').addEventListener('change', (e) => {
      selectedDevice = e.target.value || 'all';
      applyFilter();
    });
    
    fetch('/devices').then(r => r.json()).then(d => updateDeviceList(d.devices || [])).catch(console.error);
    
    let liveGraphData = [];
    let autoScale = false;
    
    function updateLiveGraph(intensity, frame) {
      try {
        console.log('Updating live graph: Frame ' + frame + ', Intensity ' + intensity);
        const graphTitle = document.querySelector('.graph-title');
        if (graphTitle) {
          graphTitle.style.color = '#ff0000';
          setTimeout(() => {
            graphTitle.style.color = 'var(--lionsmane)';
          }, 200);
        }
        liveGraphData.push({ x: frame, y: intensity });
        if (liveGraphData.length > 250) {
          liveGraphData = liveGraphData.slice(-250);
        }
        liveChart.updateSeries([{
          name: 'Goosebump intensity',
          data: liveGraphData
        }], true);
        if (autoScale && liveGraphData.length > 0) {
          const maxValue = Math.max(...liveGraphData.map(point => point.y));
          const yMax = Math.max(50, Math.ceil(maxValue * 1.2 / 10) * 10);
          liveChart.updateOptions({
            yaxis: { min: 0, max: yMax }
          }, false, true);
        }
      } catch (error) {
        console.error('Live graph update error:', error);
      }
    }
    
    document.getElementById('scaleToggle').addEventListener('click', () => {
      autoScale = !autoScale;
      const button = document.getElementById('scaleToggle');
      button.textContent = autoScale ? 'Fixed Scale' : 'Auto Scale';
      if (autoScale) {
        if (liveGraphData.length > 0) {
          const maxValue = Math.max(...liveGraphData.map(point => point.y));
          const yMax = Math.max(50, Math.ceil(maxValue * 1.2 / 10) * 10);
          liveChart.updateOptions({
            yaxis: { min: 0, max: yMax }
          }, false, true);
        }
      } else {
        liveChart.updateOptions({
          yaxis: { min: 0, max: 400 }
        }, false, true);
      }
    });
    
    const cameraBtn = document.getElementById('cameraBtn');
    const videoUpload = document.getElementById('videoUpload');
    const videoContainer = document.getElementById('videoContainer');
    const videoElement = document.getElementById('videoElement');
    const videoInfoOverlay = document.getElementById('videoInfoOverlay');
    const closeVideoBtn = document.getElementById('closeVideoBtn');
    const flashlightBtn = document.getElementById('flashlightBtn');
    const liveGraphContainer = document.getElementById('liveGraphContainer');
    let stream = null;
    let flashlightOn = false;
    let deviceId = 'mobile-camera-' + Date.now();
    
    function setupMediaDevices() {
      const hostname = window.location.hostname;
      const isRailway = hostname.includes('railway.app');
      const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';
      if (!window.isSecureContext && !isRailway) {
        console.warn('‚ö† Camera requires secure context');
        if (cameraBtn) {
          cameraBtn.textContent = 'üîí Camera (Requires HTTPS)';
          cameraBtn.disabled = true;
        }
        return false;
      }
      if (!navigator.mediaDevices) {
        navigator.mediaDevices = {};
      }
      if (!navigator.mediaDevices.getUserMedia) {
        const getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!getUserMedia) {
          return Promise.reject(new Error('getUserMedia not supported'));
        }
        navigator.mediaDevices.getUserMedia = function(constraints) {
          return new Promise((resolve, reject) => {
            getUserMedia.call(navigator, constraints, resolve, reject);
          });
        };
      }
      return true;
    }
    
    const mediaDevicesAvailable = setupMediaDevices();
    
    cameraBtn.addEventListener('click', async () => {
      if (!mediaDevicesAvailable) {
        alert('üì± Camera requires HTTPS or localhost');
        return;
      }
      if (!navigator.onLine) {
        alert('üì¥ Camera not available offline');
        return;
      }
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        let selectedCamera = null;
        for (const device of videoDevices) {
          const label = device.label.toLowerCase();
          if (label.includes('back') || label.includes('rear') || label.includes('environment')) {
            selectedCamera = device.deviceId;
            break;
          }
        }
        const constraints = {
          video: {
            deviceId: selectedCamera ? { exact: selectedCamera } : undefined,
            facingMode: selectedCamera ? undefined : 'environment',
            width: { ideal: 640, max: 1280 },
            height: { ideal: 480, max: 720 },
            frameRate: { ideal: 15, max: 20 }
          }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        videoContainer.classList.add('active');
        liveGraphContainer.classList.add('active');
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        videoInfoOverlay.innerHTML = '<div class="video-info">üìπ ' + settings.width + 'x' + settings.height + ' @ ' + settings.frameRate + 'fps</div>';
        startProcessingCameraFrames();
      } catch (err) {
        console.error('Camera error:', err);
        let errorMessage = 'Could not access camera: ' + err.message;
        if (err.name === 'NotAllowedError') {
          errorMessage = 'üö´ Camera access denied. Please allow camera access.';
        } else if (err.name === 'NotFoundError') {
          errorMessage = 'üì∑ No camera found on this device.';
        } else if (err.name === 'NotReadableError') {
          errorMessage = '‚ö† Camera is in use by another app.';
        }
        alert(errorMessage);
      }
    });
    
    closeVideoBtn.addEventListener('click', () => stopCamera());
    
    flashlightBtn.addEventListener('click', async () => {
      if (!stream) return;
      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.torch) {
        flashlightOn = !flashlightOn;
        try {
          await track.applyConstraints({ advanced: [{ torch: flashlightOn }] });
          flashlightBtn.textContent = flashlightOn ? 'üî¶' : 'üí°';
        } catch (err) {
          console.error('Flashlight error:', err);
          alert('‚ö† Could not toggle flashlight');
        }
      } else {
        alert('üí° Flashlight not supported');
      }
    });
    
    videoUpload.addEventListener('change', async (e) => {
      if (!navigator.onLine) {
        alert('üì¥ Video processing not available offline');
        e.target.value = '';
        return;
      }
      const file = e.target.files[0];
      if (file) {
        stopCamera();
        const videoURL = URL.createObjectURL(file);
        videoElement.src = videoURL;
        videoElement.srcObject = null;
        videoContainer.classList.add('active');
        videoElement.onloadedmetadata = () => {
          videoElement.play();
          startProcessingVideoFrames();
        };
      }
    });
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      videoElement.srcObject = null;
      videoElement.src = '';
      videoContainer.classList.remove('active');
      liveGraphContainer.classList.remove('active');
      liveGraphData = [];
      liveChart.updateSeries([{ name: 'Goosebump intensity', data: [] }]);
    }
    
    function startProcessingCameraFrames() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { alpha: false });
      let captureInterval = 180;
      let frameCount = 0;
      let isProcessing = false;
      const cameraDeviceId = 'mobile-camera-' + Date.now();
      deviceLastActive.set(cameraDeviceId, Date.now());
      const updateCanvasSize = () => {
        const videoWidth = videoElement.videoWidth;
        const videoHeight = videoElement.videoHeight;
        if (videoWidth && videoHeight) {
          canvas.width = videoWidth;
          canvas.height = videoHeight;
          return true;
        }
        return false;
      };
      updateCanvasSize();
      const captureFrame = () => {
        if (!stream || isProcessing) return;
        isProcessing = true;
        try {
          if (frameCount % 60 === 0) updateCanvasSize();
          const targetWidth = Math.min(canvas.width, 640);
          const targetHeight = Math.min(canvas.height, 480);
          if (canvas.width !== targetWidth || canvas.height !== targetHeight) {
            canvas.width = targetWidth;
            canvas.height = targetHeight;
          }
          ctx.drawImage(videoElement, 0, 0, targetWidth, targetHeight);
          canvas.toBlob((blob) => {
            if (!blob) {
              isProcessing = false;
              scheduleNextFrame();
              return;
            }
            frameCount++;
            const reader = new FileReader();
            reader.onloadend = () => {
              const arrayBuf = reader.result;
              socket.emit('frame_jpeg', { device_id: cameraDeviceId, frame_number: frameCount }, arrayBuf);
              deviceLastActive.set(cameraDeviceId, Date.now());
              isProcessing = false;
              scheduleNextFrame();
            };
            reader.onerror = () => {
              console.error('Error reading blob data');
              isProcessing = false;
              scheduleNextFrame();
            };
            reader.readAsArrayBuffer(blob);
          }, 'image/jpeg', 0.6);
        } catch (err) {
          console.error('Frame capture error:', err);
          isProcessing = false;
          scheduleNextFrame();
        }
      };
      const scheduleNextFrame = () => {
        if (stream) setTimeout(captureFrame, captureInterval);
      };
      videoElement.addEventListener('playing', () => {
        if (updateCanvasSize()) {
          captureFrame();
        } else {
          setTimeout(() => {
            if (updateCanvasSize()) {
              captureFrame();
            } else {
              canvas.width = 1280;
              canvas.height = 720;
              captureFrame();
            }
          }, 500);
        }
      }, { once: true });
    }
    
    function startProcessingVideoFrames() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const captureInterval = 200;
      let frameCount = 0;
      canvas.width = videoElement.videoWidth || 640;
      canvas.height = videoElement.videoHeight || 480;
      const videoUploadId = 'video-upload-' + Date.now();
      deviceLastActive.set(videoUploadId, Date.now());
      const captureFrame = () => {
        if (videoElement.paused || videoElement.ended) return;
        try {
          ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
          frameCount++;
          canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onloadend = () => {
              const base64data = reader.result.split(',')[1];
              fetch('/upload_frame', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  device_id: videoUploadId,
                  jpg_b64: base64data,
                  frame_number: frameCount
                })
              }).then(response => response.json()).then(data => {
                deviceLastActive.set(videoUploadId, Date.now());
              }).catch(err => console.error('Frame send error:', err));
            };
            reader.readAsDataURL(blob);
          }, 'image/jpeg', 0.8);
          if (!videoElement.paused && !videoElement.ended) {
            setTimeout(captureFrame, captureInterval);
          }
        } catch (err) {
          console.error('Frame capture error:', err);
          if (!videoElement.paused && !videoElement.ended) {
            setTimeout(captureFrame, captureInterval);
          }
        }
      };
      captureFrame();
    }
    
    socket.on('connect', () => {
      console.log('‚úÖ Connected to server');
    });
    socket.on('disconnect', () => {
      console.log('‚ùå Disconnected from server');
    });
  </script>
</body>
</html>
